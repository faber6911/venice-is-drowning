---
title: "Venice is drowning - final report"
date: "`r Sys.Date()`"
author: "Dario Bertazioli, Fabrizio D'Intinosante"
output:
  rmdformats::readthedown:
    highlight: kate
---


```{r knitr_init, echo=FALSE, cache=FALSE}
library(knitr)
library(rmdformats)
library(shiny)

## Global options
options(max.print="75")
opts_chunk$set(echo=FALSE,
	             cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```

<style>
body{
text-align:justify
}
</style>

# Abstract

The main objective of the project is to analyze the data of the tide detections regarding the area of the Venice lagoon, producing predictive models whose performances are evaluated on a time horizon ranging from one hour up to a week of forecast.

For this purpose, three models, both linear and machine-learning based, are tested:

* ARIMA (AutoRegressive Integrated Moving Average);
* UCM (Unobserved Component Models);
* LSTM (Long Short-Term Memory).

# Datasets

Two datasets are the basis for the project pipeline: 

  - the "main" dataset contains the tides level measurements (in cm) in the Venice lagoon from a certain reference level, obtained through the use of a sensor, between 1983 and 2018;
  - a second dataset holds the information regarding meteorological variables such as rainfall in mm, wind direction in degree at 10 meters and finally wind speed at 10 meters in meters per second in the periods between 2000 and 2019.

<!-- I dataset utilizzati per lo svolgimento della pipeline del progetto sono sostanzialmente due: un primo dataset composto dalle rilevazioni, tramite un apposito sensore, dei livelli di marea nella laguna di Venezia in cm rispetto ad un certo valore di riferimento dal 1983 fino al 2018 mentre il secondo contiene le informazioni riguardanti variabili meteorologiche (precipitazioni in millimetri, direzione del vento in gradi, velocità del vento in Km/h) dal 2000 al 2019. -->

The tides level dataset is composed using the single historical datasets made public by the city of Venice, in particular from [Centro Previsioni e Segnalazioni Maree](https://www.comune.venezia.it/node/6214). The data regarding the meteorological variables, instead have been provided, on request, by [ARPA Veneto](https://www.arpa.veneto.it/). 

All the preprocessing operations regarding parsing, inspection and the final union of the cited datasets are available in the following scripts:

<!-- 
/html realized with this order:
Il dataset dei livelli di marea è stato composto dai singoli dataset storici annuali forniti dal Comune di Venezia, in particolare dal [Centro Previsioni e Segnalazioni Maree](https://www.comune.venezia.it/node/6214). I dati riguardanti invece le variabili meteorologiche sono stati forniti, su richiesta, da [ARPA Veneto](https://www.arpa.veneto.it/). Tutte le operazioni di preprocessing riguardanti l'assemblaggio, l'ispezione e la conclusiva unione dei dataset citati sono disponibili nei seguenti script/html realizzati con questo ordine: -->

* **parsing_tides_data** allows to perform the construction of the tidal dataset, importing and unifying each single annual dataset;

<!-- è lo script utilizzato per svolgere l'operazione di assemblaggio del dataset delle maree completo, importando ed unificando tutti i dataset annuali disponibili;

-->

* **inspection** contains a series of preliminar inspection of the aformentioned data:

<!-- contiene una serie di ispezioni preliminari rispetto i dati citati;
-->

* **preprocess_weather_data_2000_2019** contains the preprocessing operations of the weather-related dataset;

<!-- contiene invece le operazioni di processing riguardanti i dati meteorologici;
-->
* **parsing_tides_weather**  reports a summary of the procedure implemented in order to deal with missing data in the weather dataset, and contains the merging operation producing the final weather dataset.

<!-- riassume infine le operazioni svolte per risolvere il problema dei dati mancanti per quanto riguarda il dataset dei dati meteorologici ed il finale *merge* dei due file.
-->
As a precise choice, due to time-related and computational reasons, only the data ranging from 2010 and 2018 are kept after the preprocessing.
<!--
Come scelta progettuale, si è deciso in fase di processing dei dati di limitare l'utilizzo di questi al periodo tra Gennaio 2010 e Dicembre 2018.
-->

# Data inspection

During the preprocessing phase, some descriptive visualizations regarding the main time series are produced in order to inspect its characteristics.  
<!--
Durante la fase di processing dei dati e prima di procedere all'effettiva realizzazione dei modelli di previsione, sono state prodotte una serie di visualizzazioni con lo scopo di ispezionare a fondo alcuni aspetti riguardanti la serie storica. 
-->

<center>
<figure>
![Figure 1](imgs/data_plot.jpg)
<figcaption>Figure 1: Time serie visualization with autocorrelation and partial autocorrelation plots</figcaption>
</figure>
</center>
<br>

Fig.1 reports the entire time series, represented together with the autocorrelation and partial autocorrealtion plots. 
Observing Fig.2, it is possible to notice how the tidal phenomenon seems to be characterized by a normal distribution. In such a case, it is worth noticing that from the analytic perspective the concepts of strict and weak stationarity are equivalent. 

<!--
In fig. 1 è possibile osservare la serie storica completa, rappresentata insieme ai plot di autocorrelazione ed autocorrelazione parziale, mentre in fig. 2 si può verificare come il fenomeno delle maree sembrerebbe distribuirsi seguendo una distribuzione normale. In questo caso, infatti, i concetti di stazionarietà debole e forte si equivalgono.
-->

<center>
<figure>
![Figure 2](imgs/distribution.jpg)
<figcaption>Figure 2: Time serie distribution</figcaption>
</figure>
</center>
<br>
During the preliminary inspection of the historycal data, one of the investigations deals with  the mean and variance stationarity of the considered time series.
Regarding the former,  Fig.1 suggests the series to be characterized by a stationary mean. This hypothesis is further proven by the output of the Augmented Dickey-Fuller test, confirming the in-mean stationarity of the tidal phenomenon.
<!--
Durante il lavoro di prima ispezione dei dati storici una delle verifiche effettuate ha riguardato la stazionarietà in media e quella in varianza: per quanto riguarda la prima osservando la serie in fig. 1 questa sembrerebbe effettivamente risultare stazionaria in media, per questa ragione per confermare l'ipotesi di stazionarietà in fig. 3 è riportato l'output di un test Augmented Dickey-Fuller che, come si vede, conferma a tutti gli effetti la stazionarietà in media del fenomeno mareale.
-->
<center>
<figure>
![Figure 3](imgs/adf_test.PNG)
<figcaption>Figure 3: output test ADF</figcaption>
</figure>
</center>
<br>
On the other hand, the latter characteristics (stationary variance) can be verified observing Fig.4, where the daily average of the tidal level values are plotted against the daily aggregation of the standard deviation. 
In particular, no clear trends emerges in such a plot, enforcing the conclusion that the plotted quantities are uncorrelated.

<!--
Successivamente alla verifica della stazionarità in media si è proceduto a verificare la stazionarietà in varianza: appare chiaro dal plot riportato in fig. 4 come i valori medi di marea per giorno e la loro *standard deviation* non risultino in un trend crescente ma anzi seguano sostanzialmente un trend piatto.
-->
<center>
<figure>
![Figure 4](imgs/var_stationary.jpg)
<figcaption>Figure 4: Visualization of stationarity in variance</figcaption>
</figure>
</center>
<br>

<!--FIXME: add a brief comment to Fig.5 
i.e.: An initial inverstigation is performed by analyzing the main stagionalities of the time series by means of a Correlogram Plot, reported in Fig.5.

but feel free to elaborate-->
<center>
<figure>
![Figure 5](imgs/periodogram.jpg)
<figcaption>Figure 5: Frequency visualization using periodogram</figcaption>
</figure>
</center>
<br>

# Models

The produced models will focus on two areas, a purely statistical one with linear models such as ARIMA and UCM and a a machine learning approach, through the investigation of an LSTM model. 
The preparation and implementation of the models will be presented below and a section of results, where it will be possible to make a rapid comparison between the performance of the models on a test set defined a priori, will be eventually proposed. 
For the modelling approach, it is worth highlighting the different subsets of the whole dataset exploited for each one of the described areas:

<!-- Come anticipato, i modelli realizzati vertono su due ambiti, uno più puramente statistico di modelli lineari ovvero ARIMA ed UCM e l'altro di machine learning, attraverso la definizione di un modello LSTM. Di seguito verranno presentati i preparativi e le implementazioni dei modelli ed infine verrà proposta una sezione di risultati in cui sarà possibile effettuare un rapido confronto tra le prestazioni dei modelli su un test set definito a priori. A questo proposito vale la pena di sottolineare i dati utilizzati per entrambi gli ambiti: -->

* for the linear models the training set is composed by the last six months of 2018, from July to December;
* for the machine learning approach, considering the capability of handling more data within a non-explosive  computational time, the training set covers the period between January 2010 and December 2018. 

The test set, previously extracted, is common among the different approaches and consists of the last two weeks of December 2018, i.e. from 17/12/2018 23:00:00 to 31/12/2019 23:00:00.

<!-- * per i modelli lineari il training set consiste negli ultimi sei mesi del 2018, a partire da Luglio fino a Dicembre 2018; -->
<!-- * per il modello machine learning, data la sua capacità di gestire moli di dati decisamente superiori a parità di tempo di computazione, come training set è stato utilizzato tutto il dataset a partire da Gennaio 2010 fino a Dicembre 2018. -->

<!-- Il test set, estratto a priori, consiste nell'ultima settimana di Dicembre 2018, ovvero dal 24/12/2018 23:00:00 al 31/12/2018 alle 23:00:00. -->

<center>
<figure>
![Figure 6](imgs/train_test.jpg)
<figcaption>Figure 6: Train and test data representation</figcaption>
</figure>
</center>
<br>
<!--FIXME: got till here-->
<!-- Entrambi i modelli lineari realizzati, come detto, utilizzano come training set i dati delle maree a partire dal 01/07/2018 00:00:00 fino al 24/12/2018 23:00:00. Questa scelta è stata guidata da esigenze di ottimizzazione dei tempi di *fitting* dei modelli poichè, selezionando più dati, si è riscontrato un importante dilatamento di questi. Sia ARIMA che UCM sono stati scritti in R, utilizzando a questo scopo i pacchetti *forecast* e *KFAS*. -->

Concerning the linear models, two strategies are considered: the former consists of integrating the meteorological variables and the lunar motion in the main analysis, while the latter is based on performing a sort of harmonic analysis by re-using some of the most common principal periodic components  previously extracted from other studies in the field. 
<!-- FIXME: add ref to the survey on tidal prediction strategies and add [1] as ref. -->
The adaptation of such components to our series is done exploiting *oce*, an R package that helps Oceanographers with their work by providing utils to investigate and elaborate Oceanographic data files.

<!-- FIXME: this part should be elaborated in the dataset section in order to introduce the dataset "lunar motion".

Regarding the first strategy, after processing the meteorological data as previously mentioned, using the API *PyEphem*, an astronomy library that provides basic astronomical computations for the Python programming language. Given a date and location on the Earth’s surface, it can compute the positions of the Sun and Moon, of the planets and their moons, and of any asteroids, comets, or earth satellites whose orbital elements the user can provide. In order to track the lunar motion all we have to do is to select the period of interest and the coordinates representing Venice.
-->
<div align="center">
<figure>
```{r lunar_motion, out.width="60%", tidy=TRUE}
shiny::includeHTML("imgs/test.html")
```
<figcaption>Figure 7: Interactive plot representing lunar motion between 2010 and 2018</figcaption>
</figure>
</div>
<br>
The second strategy instead, as anticipated, concerns the extraction of principal periodic components  from a time series about sea levels commonly treated in literature, and the re-using of those components as regressors for the tides level time series of Venice. 
The *oce* package provide a function called *tidem* able to fit a model in terms of sine and cosine components at the indicated tidal frequencies, with the amplitude and phase being calculated from the resultant coefficients on the sine and cosine terms. 
*Tidem* provides the possibility to "adapt" up to 69 components but we focused on 8 of them, in particular:

* M2, main lunar semi-diurnal with a period of ~12 hours;
* S2, main solar semi-diurnal (~12 hours);
* N2, lunar-elliptic semi-diurnal (~13 hours);
* K2, lunar-solar semi-diurnal (~12 hours);
* K1, lunar-solar diurnal (~24 hours);
* O1, main lunar diurnal (~26 hours);
* SA, solar annual (~24*365 hours);
* P1, main solar diurnal (24 hours).

<div align="center">
<figure>
```{r components, out.width="60%"}
shiny::includeHTML("imgs/components.html")
```
<figcaption>Figure 8: Interactive filtering plot for the extracted components</figcaption>
</figure>
</div>

## ARIMA

Both the realized linear models use the data between 25/06/2018 00:00:00 and 17/12/2018 23:00:00 as training set. This choice is determined by the needs of optimizing the models' fitting time because, taking more data, there would have been an important computational-time explosion. 
Both ARIMA and UCM are implemented in R, in particular with *forecast* and *KFAS* packages.

As a first approach to the forecast task we trained two ARIMA models: the former is trained using as regressors the meteorological data provided by ARPA Veneto with the lunar motion obtained using *PyEPhem* while the latter using the 8 harmonics from  *oce* and *tidem*.

Starting from the first model, it's worth to notice that the meteorological data have been standardized and the lunar motion is elaborated in the following form, recalling the general shape of the grativational potential (proportional to the inverse of the squared distance):

\begin{equation}
lunar\_var = \frac{1}{lunar\_motion^2}
\end{equation}

The first impact of the variable is substantially insignificant as is possible to observe in Fig.9: the correlations and the partial correlations mantain their magnitude and the fitting on the training data is weak.

<center>
<figure>
![Figure 9](imgs/ar1_1.jpg)
<figcaption>Figure 9: First output from ARIMA 1</figcaption>
</figure>
</center>
<br>

After several attemps, following the represented Lag on ACF and PACF plots in combination with the value of the AICc and the Mean Absolute Percentage Error (MAPE), a highly parameterized model has been reached with the form (3,1,3)(1,1,3)[24]. 
Although the autocorrelation has not been completely absorbed, the Box-Ljung test indicates that it is no longer relevant for the first few hours. 
The fitting on the training set also improves considerably and the performance on the test proves to be quite good as it will be illustrated below. 
The autocorrelation and the fitting performances are visible in Fig.10.

<center>
<figure>
![Figure 10](imgs/ar1_2_acfpacf.jpg)
![Figure 10b](imgs/ar1_2_fit.jpg)
<figcaption>Figure 10: Final output from ARIMA 1</figcaption>
</figure>
</center>
<br>
As anticipated, the second ARIMA model realized use as input regressors the 8 harmonics extracted using *tidem* and *oce*. Since it is a functional form based solely on time, it is possible for us to obtain them also for the projections. An example of this harmonics is shown in fig. 8 in an interactive fashion. The effect of the use of harmonics is already visible starting from the basic model, that is, the one without autoregressive components or moving average.

<center>
<figure>
![Figure 11](imgs/ar2_1.jpg)
<figcaption>Figure 11: Initial output from ARIMA 2</figcaption>
</figure>
</center>
<br>

<center>
<figure>
![Figure 12](imgs/ar2_2_acfpacf.jpg)
![Figure 12b](imgs/ar2_2_fit.jpg)
<figcaption>Figure 12: Final output from ARIMA 2</figcaption>
</figure>
</center>
<br>

## UCM

## LSTM

Inserire qui procedimento svolto LSTM

# Results

<div align="center">
<figure>
```{r results, out.width="60%"}
shiny::includeHTML("results.html")
```
<figcaption>Figure X:</figcaption>
</figure>
</div>


# Conclusions